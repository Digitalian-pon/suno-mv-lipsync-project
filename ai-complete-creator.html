<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸµ AI Complete Music Creator | AIå®Œå…¨éŸ³æ¥½ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #764ba2;
            font-size: 1.2em;
            margin-top: -15px;
            margin-bottom: 20px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        
        .api-key-area {
            width: 100%;
            min-height: 60px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            background: white;
            color: #333;
            overflow-wrap: break-word;
            word-break: break-all;
            outline: none;
        }
        
        .api-key-area:focus {
            border-color: #667eea;
            background: #fafafa;
        }
        
        .api-key-area[contenteditable="true"]:empty:before {
            content: "ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦APIã‚­ãƒ¼ã‚’å…¥åŠ›";
            color: #999;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .help-text {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .theme-display {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }
        
        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .result-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .api-method-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .method-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .method-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .method-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }
        
        .controls label {
            font-weight: bold;
            color: #667eea;
        }
        
        .controls select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .controls select:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .model-select {
            margin: 10px 0;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 8px;
        }
        
        .model-select label {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }
        
        .model-select select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ AI Complete Creator<br><span style="font-size: 0.6em; color: #764ba2;">AIå®Œå…¨éŸ³æ¥½ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</span></h1>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            Claude & Gemini AI æ¥½æ›²ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå®Œå…¨AIç”Ÿæˆç‰ˆï¼‰
        </div>
        
        <!-- APIé¸æŠ -->
        <div class="section" style="background: linear-gradient(135deg, #FFE5EC, #E5E5FF);">
            <h3>ğŸ¤– AI APIé¸æŠ</h3>
            <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
                <button class="method-btn active" id="apiClaude" onclick="selectAPI('claude')" style="flex: 1; max-width: 200px;">
                    ğŸ­ Claude API
                </button>
                <button class="method-btn" id="apiGemini" onclick="selectAPI('gemini')" style="flex: 1; max-width: 200px;">
                    ğŸ’ Gemini API
                </button>
            </div>
            
            <!-- Geminiãƒ¢ãƒ‡ãƒ«é¸æŠ -->
            <div class="model-select" id="geminiModelSelect" style="display: none;">
                <label>ğŸ’ Geminiãƒ¢ãƒ‡ãƒ«:</label>
                <select id="geminiModel" onchange="updateGeminiModel()">
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental) - æœ€æ–°</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash - é«˜é€Ÿ</option>
                    <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B - è»½é‡</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro - é«˜æ€§èƒ½</option>
                </select>
            </div>
        </div>
        
        <!-- APIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section" id="apiSection">
            <h3 id="apiTitle">ğŸ­ Claude APIè¨­å®š</h3>
            
            <div class="help-text">
                <strong>ğŸ“± APIã‚­ãƒ¼å…¥åŠ›æ–¹æ³•ï¼š</strong>
            </div>
            
            <div class="api-method-buttons">
                <button class="method-btn active" id="method1" onclick="selectMethod(1)">
                    ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å…¥åŠ›
                </button>
                <button class="method-btn" id="method2" onclick="selectMethod(2)">
                    ç›´æ¥å…¥åŠ›
                </button>
            </div>
            
            <!-- æ–¹æ³•1: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
            <div id="method1Content" style="display: block;">
                <button class="btn btn-warning" onclick="promptForApiKey()">
                    ğŸ“ APIã‚­ãƒ¼ã‚’å…¥åŠ›ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰
                </button>
                <div id="promptResult" style="margin-top: 10px; font-family: monospace; font-size: 12px; color: #666;"></div>
            </div>
            
            <!-- æ–¹æ³•2: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†å¯èƒ½div -->
            <div id="method2Content" style="display: none;">
                <div class="help-text" style="background: #fff3cd; border-color: #ffc107;">
                    ä¸‹ã®æ å†…ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€APIã‚­ãƒ¼ã‚’ç›´æ¥å…¥åŠ›ã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
                </div>
                <div 
                    id="apiKeyDiv" 
                    class="api-key-area"
                    contenteditable="true"
                    spellcheck="false"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    oninput="onApiKeyDivChange()"
                ></div>
                <div id="divCharCount" style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">0æ–‡å­—</div>
            </div>
            
            <!-- å…±é€šãƒœã‚¿ãƒ³ -->
            <button class="btn" onclick="testConnection()" id="testBtn">
                ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ
            </button>
            
            <button class="btn btn-danger" onclick="clearApiKey()">
                ğŸ—‘ï¸ APIã‚­ãƒ¼ã‚¯ãƒªã‚¢
            </button>
            
            <div id="apiStatus"></div>
        </div>
        
        <!-- ãƒ†ãƒ¼ãƒç”Ÿæˆ -->
        <div class="section">
            <h3>ğŸ¯ æ¥½æ›²ãƒ†ãƒ¼ãƒï¼ˆå®Œå…¨AIç”Ÿæˆï¼‰</h3>
            
            <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆ -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center;">
                <button class="method-btn active" id="langJa" onclick="switchLanguage('ja')" style="width: 100px;">
                    ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª
                </button>
                <button class="method-btn" id="langEn" onclick="switchLanguage('en')" style="width: 100px;">
                    ğŸ‡ºğŸ‡¸ English
                </button>
            </div>
            
            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ -->
            <div style="margin-bottom: 15px;">
                <label style="color: #667eea; font-weight: bold;">ãƒ†ãƒ¼ãƒã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:</label>
                <select id="themeCategory" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                    <option value="random">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆAIã«ãŠä»»ã›ï¼‰</option>
                    <option value="romance">ğŸ’• æ‹æ„›ãƒ»ãƒ­ãƒãƒ³ã‚¹</option>
                    <option value="friendship">ğŸ¤ å‹æƒ…ãƒ»çµ†</option>
                    <option value="dream">ğŸŒŸ å¤¢ãƒ»æŒ‘æˆ¦</option>
                    <option value="daily">â˜€ï¸ æ—¥å¸¸ãƒ»ç”Ÿæ´»</option>
                    <option value="digital">ğŸ’» ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼</option>
                    <option value="fantasy">ğŸ¦„ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ»SF</option>
                    <option value="dark">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ»ã‚·ãƒªã‚¢ã‚¹</option>
                    <option value="nostalgia">ğŸ“¼ ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒ¼ãƒ»ãƒ¬ãƒˆãƒ­</option>
                    <option value="adventure">ğŸ”ï¸ å†’é™ºãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</option>
                    <option value="mystery">ğŸ” ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒ»ã‚µã‚¹ãƒšãƒ³ã‚¹</option>
                    <option value="comedy">ğŸ˜„ ã‚³ãƒ¡ãƒ‡ã‚£ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢</option>
                    <option value="sports">âš½ ã‚¹ãƒãƒ¼ãƒ„ãƒ»ç«¶æŠ€</option>
                    <option value="art">ğŸ¨ éŸ³æ¥½ãƒ»ã‚¢ãƒ¼ãƒˆ</option>
                    <option value="school">ğŸ“ å­¦åœ’ãƒ»ã‚¹ã‚¯ãƒ¼ãƒ«</option>
                    <option value="work">ğŸ’¼ ä»•äº‹ãƒ»ãƒ“ã‚¸ãƒã‚¹</option>
                    <option value="travel">âœˆï¸ æ—…è¡Œãƒ»è¦³å…‰</option>
                    <option value="food">ğŸœ é£Ÿã¹ç‰©ãƒ»ã‚°ãƒ«ãƒ¡</option>
                    <option value="pet">ğŸ• ãƒšãƒƒãƒˆãƒ»å‹•ç‰©</option>
                    <option value="nature">ğŸŒ¿ è‡ªç„¶ãƒ»é¢¨æ™¯</option>
                </select>
            </div>
            
            <!-- ãƒ†ãƒ¼ãƒç”Ÿæˆãƒœã‚¿ãƒ³ -->
            <button class="btn btn-secondary" onclick="generateAITheme()" id="aiThemeBtn">
                ğŸ¤– AIãƒ†ãƒ¼ãƒç”Ÿæˆï¼ˆå®Œå…¨ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰
            </button>
            
            <!-- ãƒ†ãƒ¼ãƒè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç·¨é›†å¯èƒ½ï¼‰ -->
            <div class="theme-display" id="themeDisplay" contenteditable="true" style="cursor: text;">
                ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
            </div>
            <div style="text-align: center; margin-top: 5px; color: #666; font-size: 12px;">
                âœï¸ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†å¯èƒ½
            </div>
        </div>
        
        <!-- æ¥½æ›²ç”Ÿæˆ -->
        <div class="section">
            <button class="btn" onclick="generateSong()" id="generateBtn" disabled>
                ğŸš€ 3åˆ†æ¥½æ›²ã‚’ç”Ÿæˆï¼ˆè¦APIæ¥ç¶šï¼‰
            </button>
        </div>

        <!-- MVç”¨ Text to Video ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ -->
        <div class="section" style="background: linear-gradient(135deg, #FFE5E5, #E5F5FF);">
            <h3>ğŸ¬ MVç”¨ Text to Video ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</h3>
            <div class="help-text" style="background: #E5F5FF; border-color: #667eea;">
                æ¥½æ›²ãƒ†ãƒ¼ãƒã‹ã‚‰ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªç”¨ã®å‹•ç”»ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’AIãŒä½œæˆã—ã¾ã™
            </div>

            <!-- å‹•ç”»ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ -->
            <div style="margin: 15px 0;">
                <label style="color: #667eea; font-weight: bold;">å‹•ç”»ã‚¹ã‚¿ã‚¤ãƒ«:</label>
                <select id="videoStyle" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                    <option value="cinematic">ğŸ¥ æ˜ ç”»çš„ãƒ»ã‚·ãƒãƒãƒ†ã‚£ãƒƒã‚¯</option>
                    <option value="anime">ğŸ¨ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¢¨</option>
                    <option value="abstract">ğŸŒˆ æŠ½è±¡çš„ãƒ»ã‚¢ãƒ¼ãƒˆ</option>
                    <option value="realistic">ğŸ“¸ ãƒªã‚¢ãƒ«ãƒ»å®Ÿå†™é¢¨</option>
                    <option value="retro">ğŸ“¼ ãƒ¬ãƒˆãƒ­ãƒ»ãƒ“ãƒ³ãƒ†ãƒ¼ã‚¸</option>
                    <option value="futuristic">ğŸš€ æœªæ¥çš„ãƒ»SF</option>
                    <option value="minimalist">âšª ãƒŸãƒ‹ãƒãƒ«ãƒ»ã‚·ãƒ³ãƒ—ãƒ«</option>
                    <option value="vibrant">ğŸŒŸ ã‚«ãƒ©ãƒ•ãƒ«ãƒ»é®®ã‚„ã‹</option>
                </select>
            </div>

            <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒœã‚¿ãƒ³ -->
            <button class="btn btn-secondary" onclick="generateVideoPrompt()" id="videoPromptBtn" disabled>
                ğŸ¬ MVç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆè¦ãƒ†ãƒ¼ãƒï¼†APIæ¥ç¶šï¼‰
            </button>

            <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç·¨é›†å¯èƒ½ï¼‰ -->
            <div id="videoPromptDisplay" contenteditable="true" style="
                min-height: 100px;
                padding: 15px;
                margin: 15px 0;
                border: 2px solid #ddd;
                border-radius: 10px;
                background: white;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 14px;
                color: #333;
                cursor: text;
                display: none;
            ">
            </div>

            <!-- ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ -->
            <button class="btn btn-warning" onclick="copyVideoPrompt()" id="copyVideoBtn" style="display: none;">
                ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
            </button>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div id="results"></div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let apiKey = '';
        let apiConnected = false;
        let currentTheme = '';
        let isGenerating = false;
        let selectedMethod = 1;
        let currentData = {};
        let selectedAPI = 'claude';
        let currentLanguage = 'ja';
        let geminiModel = 'gemini-2.0-flash-exp';
        let generatedThemes = [];
        
        // åˆæœŸåŒ–
        window.onload = function() {
            const savedClaude = localStorage.getItem('claudeApiKey');
            const savedGemini = localStorage.getItem('geminiApiKey');
            
            if (savedClaude) {
                selectedAPI = 'claude';
                apiKey = savedClaude;
                displayApiKey();
                setTimeout(() => testConnection(), 1000);
            } else if (savedGemini) {
                selectedAPI = 'gemini';
                selectAPI('gemini');
                apiKey = savedGemini;
                displayApiKey();
                setTimeout(() => testConnection(), 1000);
            }

            // ä¿å­˜ã•ã‚ŒãŸGeminiãƒ¢ãƒ‡ãƒ«ã‚’å¾©å…ƒ
            const savedGeminiModel = localStorage.getItem('selectedGeminiModel');
            if (savedGeminiModel) {
                geminiModel = savedGeminiModel;
                document.getElementById('geminiModel').value = savedGeminiModel;
            }

            // ãƒ†ãƒ¼ãƒç·¨é›†æ©Ÿèƒ½ã®åˆæœŸåŒ–
            const themeDisplay = document.getElementById('themeDisplay');
            if (themeDisplay) {
                themeDisplay.addEventListener('input', function() {
                    currentTheme = this.textContent.replace(/^[ğŸ”¥ğŸ²]\s*/, '');
                });
                
                themeDisplay.addEventListener('focus', function() {
                    if (this.textContent === 'ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„') {
                        this.textContent = '';
                    }
                });
                
                themeDisplay.addEventListener('blur', function() {
                    if (this.textContent === '') {
                        this.textContent = 'ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„';
                    }
                });
            }
        };
        
        // APIé¸æŠ
        function selectAPI(api) {
            selectedAPI = api;
            document.getElementById('apiClaude').classList.remove('active');
            document.getElementById('apiGemini').classList.remove('active');
            document.getElementById('api' + api.charAt(0).toUpperCase() + api.slice(1)).classList.add('active');
            
            const apiTitle = document.getElementById('apiTitle');
            const geminiModelSelect = document.getElementById('geminiModelSelect');
            
            if (api === 'claude') {
                apiTitle.innerHTML = 'ğŸ­ Claude APIè¨­å®š';
                apiKey = localStorage.getItem('claudeApiKey') || '';
                if (geminiModelSelect) geminiModelSelect.style.display = 'none';
            } else {
                apiTitle.innerHTML = 'ğŸ’ Gemini APIè¨­å®š';
                apiKey = localStorage.getItem('geminiApiKey') || '';
                if (geminiModelSelect) geminiModelSelect.style.display = 'block';
            }
            
            displayApiKey();
            apiConnected = false;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('apiStatus').innerHTML = '';
        }
        
        // Geminiãƒ¢ãƒ‡ãƒ«æ›´æ–°
        function updateGeminiModel() {
            geminiModel = document.getElementById('geminiModel').value;
            localStorage.setItem('selectedGeminiModel', geminiModel);
            console.log('Gemini model updated to:', geminiModel);
        }
        
        // è¨€èªåˆ‡ã‚Šæ›¿ãˆ
        function switchLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('langJa').classList.toggle('active', lang === 'ja');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            const categorySelect = document.getElementById('themeCategory');
            if (lang === 'en') {
                categorySelect.innerHTML = `
                    <option value="random">ğŸ² Random (AI Choice)</option>
                    <option value="romance">ğŸ’• Romance</option>
                    <option value="friendship">ğŸ¤ Friendship</option>
                    <option value="dream">ğŸŒŸ Dreams & Ambitions</option>
                    <option value="daily">â˜€ï¸ Daily Life</option>
                    <option value="digital">ğŸ’» Digital & Tech</option>
                    <option value="fantasy">ğŸ¦„ Fantasy & Sci-Fi</option>
                    <option value="dark">ğŸŒ™ Dark & Serious</option>
                    <option value="nostalgia">ğŸ“¼ Nostalgia & Retro</option>
                    <option value="adventure">ğŸ”ï¸ Adventure & Action</option>
                    <option value="mystery">ğŸ” Mystery & Suspense</option>
                    <option value="comedy">ğŸ˜„ Comedy & Humor</option>
                    <option value="sports">âš½ Sports</option>
                    <option value="art">ğŸ¨ Music & Art</option>
                    <option value="school">ğŸ“ School Life</option>
                    <option value="work">ğŸ’¼ Work & Business</option>
                    <option value="travel">âœˆï¸ Travel</option>
                    <option value="food">ğŸœ Food & Cuisine</option>
                    <option value="pet">ğŸ• Pets & Animals</option>
                    <option value="nature">ğŸŒ¿ Nature & Landscape</option>
                `;
            } else {
                categorySelect.innerHTML = `
                    <option value="random">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆAIã«ãŠä»»ã›ï¼‰</option>
                    <option value="romance">ğŸ’• æ‹æ„›ãƒ»ãƒ­ãƒãƒ³ã‚¹</option>
                    <option value="friendship">ğŸ¤ å‹æƒ…ãƒ»çµ†</option>
                    <option value="dream">ğŸŒŸ å¤¢ãƒ»æŒ‘æˆ¦</option>
                    <option value="daily">â˜€ï¸ æ—¥å¸¸ãƒ»ç”Ÿæ´»</option>
                    <option value="digital">ğŸ’» ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼</option>
                    <option value="fantasy">ğŸ¦„ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ»SF</option>
                    <option value="dark">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ»ã‚·ãƒªã‚¢ã‚¹</option>
                    <option value="nostalgia">ğŸ“¼ ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒ¼ãƒ»ãƒ¬ãƒˆãƒ­</option>
                    <option value="adventure">ğŸ”ï¸ å†’é™ºãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</option>
                    <option value="mystery">ğŸ” ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒ»ã‚µã‚¹ãƒšãƒ³ã‚¹</option>
                    <option value="comedy">ğŸ˜„ ã‚³ãƒ¡ãƒ‡ã‚£ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢</option>
                    <option value="sports">âš½ ã‚¹ãƒãƒ¼ãƒ„ãƒ»ç«¶æŠ€</option>
                    <option value="art">ğŸ¨ éŸ³æ¥½ãƒ»ã‚¢ãƒ¼ãƒˆ</option>
                    <option value="school">ğŸ“ å­¦åœ’ãƒ»ã‚¹ã‚¯ãƒ¼ãƒ«</option>
                    <option value="work">ğŸ’¼ ä»•äº‹ãƒ»ãƒ“ã‚¸ãƒã‚¹</option>
                    <option value="travel">âœˆï¸ æ—…è¡Œãƒ»è¦³å…‰</option>
                    <option value="food">ğŸœ é£Ÿã¹ç‰©ãƒ»ã‚°ãƒ«ãƒ¡</option>
                    <option value="pet">ğŸ• ãƒšãƒƒãƒˆãƒ»å‹•ç‰©</option>
                    <option value="nature">ğŸŒ¿ è‡ªç„¶ãƒ»é¢¨æ™¯</option>
                `;
            }
        }
        
        // å…¥åŠ›æ–¹æ³•é¸æŠ
        function selectMethod(method) {
            selectedMethod = method;
            
            document.querySelectorAll('.method-btn').forEach(btn => {
                if (btn.id.startsWith('method')) {
                    btn.classList.remove('active');
                }
            });
            document.getElementById('method' + method).classList.add('active');
            
            document.getElementById('method1Content').style.display = method === 1 ? 'block' : 'none';
            document.getElementById('method2Content').style.display = method === 2 ? 'block' : 'none';
        }
        
        // APIã‚­ãƒ¼å…¥åŠ›ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰
        function promptForApiKey() {
            const apiName = selectedAPI === 'claude' ? 'Claude' : 'Gemini';
            const format = selectedAPI === 'claude' ? 'sk-ant-api...ã§å§‹ã¾ã‚‹100æ–‡å­—ç¨‹åº¦' : 'AIzaSy...ã§å§‹ã¾ã‚‹40æ–‡å­—ç¨‹åº¦';
            
            const input = prompt(`${apiName} APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ${format}ï¼‰:`);
            if (input && input.trim()) {
                apiKey = input.trim();
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                displayApiKey();
                document.getElementById('apiStatus').innerHTML = '<div class="status warning">APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>';
            }
        }
        
        // APIã‚­ãƒ¼å…¥åŠ›å¤‰æ›´æ™‚
        function onApiKeyDivChange() {
            const div = document.getElementById('apiKeyDiv');
            const text = div.textContent || div.innerText || '';
            const count = document.getElementById('divCharCount');
            
            count.textContent = text.length + 'æ–‡å­—';
            
            const isValid = (selectedAPI === 'claude' && text.startsWith('sk-ant-api') && text.length >= 100) ||
                           (selectedAPI === 'gemini' && text.startsWith('AIzaSy') && text.length >= 39);
            
            if (isValid) {
                apiKey = text.trim();
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                count.innerHTML = text.length + 'æ–‡å­— <span style="color: green;">âœ…</span>';
            } else if (text.length > 0) {
                count.innerHTML = text.length + 'æ–‡å­— <span style="color: orange;">âš ï¸</span>';
            }
        }
        
        // APIã‚­ãƒ¼è¡¨ç¤º
        function displayApiKey() {
            if (apiKey) {
                const masked = apiKey.substring(0, 10) + '...' + apiKey.substring(apiKey.length - 5);
                document.getElementById('promptResult').textContent = 'APIã‚­ãƒ¼: ' + masked;
                document.getElementById('apiKeyDiv').textContent = apiKey;
                onApiKeyDivChange();
            }
        }
        
        // æ–‡å­—åŒ–ã‘ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã™ã‚‹å‡¦ç†
        function fixTextEncoding(text) {
            if (!text) return '';

            // ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰å‹æ–‡å­—åŒ–ã‘è¨˜å·ã‚’ä¿®æ­£
            return text
                .replace(/\uFFFD/g, '') // Unicode replacement character
                .replace(/\u00EF\u00BF\u00BD/g, '') // UTF-8 byte sequence
                .replace(/ï¿½/g, '') // Question mark in diamond
                .replace(/\uffff/g, '') // Invalid character
                .trim();
        }


        // APIã‚­ãƒ¼ã‚¯ãƒªã‚¢
        function clearApiKey() {
            if (confirm('APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                apiKey = '';
                localStorage.removeItem(selectedAPI + 'ApiKey');
                apiConnected = false;
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('apiStatus').innerHTML = '';
                document.getElementById('promptResult').textContent = '';
                document.getElementById('apiKeyDiv').textContent = '';
                document.getElementById('divCharCount').textContent = '0æ–‡å­—';
                alert('APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }
        
        // APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            const status = document.getElementById('apiStatus');
            const testBtn = document.getElementById('testBtn');
            const generateBtn = document.getElementById('generateBtn');
            
            if (selectedMethod === 2) {
                const div = document.getElementById('apiKeyDiv');
                const text = (div.textContent || div.innerText || '').trim();
                if (text.startsWith('sk-ant-api') || text.startsWith('AIzaSy')) {
                    apiKey = text;
                }
            }
            
            if (!apiKey) {
                status.innerHTML = '<div class="status error">âŒ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ ãƒ†ã‚¹ãƒˆä¸­...';
            status.innerHTML = '<div class="status warning">â³ æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...</div>';
            
            try {
                const endpoint = selectedAPI === 'claude' ? '/api/claude' : '/api/gemini';
                const requestBody = {
                    apiKey: apiKey,
                    prompt: 'Hello test',
                    temperature: 0.1
                };
                
                if (selectedAPI === 'gemini') {
                    requestBody.model = geminiModel;
                }
                
                // å‹•çš„ã«ãƒ™ãƒ¼ã‚¹URLã‚’å–å¾—ï¼ˆlocalhost ã¾ãŸã¯ å¤–éƒ¨IPï¼‰
                const baseUrl = window.location.origin;
                const response = await fetch(baseUrl + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok && (data.content || data.candidates)) {
                    apiConnected = true;
                    generateBtn.disabled = false;
                    status.innerHTML = '<div class="status success">âœ… æ¥ç¶šæˆåŠŸï¼AIç”ŸæˆãŒåˆ©ç”¨å¯èƒ½ã§ã™</div>';
                    localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                } else {
                    throw new Error(data.error?.message || data.error || 'Connection failed');
                }
            } catch (error) {
                apiConnected = false;
                generateBtn.disabled = true;
                status.innerHTML = `<div class="status error">âŒ æ¥ç¶šå¤±æ•—: ${error.message}</div>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ';
            }
        }
        
        // AIãƒ†ãƒ¼ãƒç”Ÿæˆï¼ˆå®Œå…¨AIç”Ÿæˆï¼‰
        async function generateAITheme() {
            const btn = document.getElementById('aiThemeBtn');
            const display = document.getElementById('themeDisplay');
            
            if (!apiConnected) {
                alert('å…ˆã«APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’æˆåŠŸã•ã›ã¦ãã ã•ã„');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'ğŸ¤– ç”Ÿæˆä¸­...';
            display.textContent = 'AIãŒç‹¬å‰µçš„ãªãƒ†ãƒ¼ãƒã‚’è€ƒæ¡ˆä¸­...';
            
            try {
                const category = document.getElementById('themeCategory').value;
                const randomSeed = Math.floor(Math.random() * 10000);
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®è¨­å®š
                let categoryText = '';
                if (category !== 'random') {
                    const categoryMap = {
                        'romance': currentLanguage === 'ja' ? 'æ‹æ„›ãƒ»ãƒ­ãƒãƒ³ã‚¹' : 'Romance',
                        'friendship': currentLanguage === 'ja' ? 'å‹æƒ…ãƒ»çµ†' : 'Friendship',
                        'dream': currentLanguage === 'ja' ? 'å¤¢ãƒ»æŒ‘æˆ¦' : 'Dreams & Ambitions',
                        'daily': currentLanguage === 'ja' ? 'æ—¥å¸¸ãƒ»ç”Ÿæ´»' : 'Daily Life',
                        'digital': currentLanguage === 'ja' ? 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼' : 'Digital & Tech',
                        'fantasy': currentLanguage === 'ja' ? 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ»SF' : 'Fantasy & Sci-Fi',
                        'dark': currentLanguage === 'ja' ? 'ãƒ€ãƒ¼ã‚¯ãƒ»ã‚·ãƒªã‚¢ã‚¹' : 'Dark & Serious',
                        'nostalgia': currentLanguage === 'ja' ? 'ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒ¼ãƒ»ãƒ¬ãƒˆãƒ­' : 'Nostalgia & Retro',
                        'adventure': currentLanguage === 'ja' ? 'å†’é™ºãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³' : 'Adventure & Action',
                        'mystery': currentLanguage === 'ja' ? 'ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒ»ã‚µã‚¹ãƒšãƒ³ã‚¹' : 'Mystery & Suspense',
                        'comedy': currentLanguage === 'ja' ? 'ã‚³ãƒ¡ãƒ‡ã‚£ãƒ»ãƒ¦ãƒ¼ãƒ¢ã‚¢' : 'Comedy & Humor',
                        'sports': currentLanguage === 'ja' ? 'ã‚¹ãƒãƒ¼ãƒ„ãƒ»ç«¶æŠ€' : 'Sports',
                        'art': currentLanguage === 'ja' ? 'éŸ³æ¥½ãƒ»ã‚¢ãƒ¼ãƒˆ' : 'Music & Art',
                        'school': currentLanguage === 'ja' ? 'å­¦åœ’ãƒ»ã‚¹ã‚¯ãƒ¼ãƒ«' : 'School Life',
                        'work': currentLanguage === 'ja' ? 'ä»•äº‹ãƒ»ãƒ“ã‚¸ãƒã‚¹' : 'Work & Business',
                        'travel': currentLanguage === 'ja' ? 'æ—…è¡Œãƒ»è¦³å…‰' : 'Travel',
                        'food': currentLanguage === 'ja' ? 'é£Ÿã¹ç‰©ãƒ»ã‚°ãƒ«ãƒ¡' : 'Food & Cuisine',
                        'pet': currentLanguage === 'ja' ? 'ãƒšãƒƒãƒˆãƒ»å‹•ç‰©' : 'Pets & Animals',
                        'nature': currentLanguage === 'ja' ? 'è‡ªç„¶ãƒ»é¢¨æ™¯' : 'Nature & Landscape'
                    };
                    categoryText = categoryMap[category] || '';
                }
                
                // å®Œå…¨AIå‰µé€ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆé©å‘½çš„å‰µé€ æ€§ï¼‰

                // äººã®å¿ƒã«éŸ¿ãæ„Ÿæƒ…çš„è¦ç´ ã‚’ç”Ÿæˆ
                // randomSeed already declared above, reusing same value

                // æ„Ÿå‹•çš„ãªäººé–“ä½“é¨“ã®è¦ç´ 
                const humanExperiences = [
                    'åˆæ‹ã®æ€ã„å‡º', 'å®¶æ—ã®æ¸©ã‹ã•', 'å‹é”ã¨ã®çµ†', 'æ•…éƒ·ã¸ã®æƒ³ã„', 'å¤¢ã¸ã®æŒ‘æˆ¦',
                    'åˆ¥ã‚Œã®åˆ‡ãªã•', 'å†ä¼šã®å–œã³', 'æˆé•·ã®å®Ÿæ„Ÿ', 'æ„Ÿè¬ã®æ°—æŒã¡', 'å¸Œæœ›ã®å…‰',
                    'é’æ˜¥ã®1ãƒšãƒ¼ã‚¸', 'å¤§åˆ‡ãªç´„æŸ', 'å¿ƒã®æ”¯ãˆ', 'æ–°ã—ã„å‡ºç™º', 'å¤‰ã‚ã‚‰ã¬æ„›',
                    'æ‡ã‹ã—ã„é¢¨æ™¯', 'ç¬‘é¡”ã®è¨˜æ†¶', 'æ¶™ã®æ„å‘³', 'å‹‡æ°—ã®æº', 'å„ªã—ã„è¨€è‘‰'
                ];
                const randomExperience = humanExperiences[Math.floor(Math.random() * humanExperiences.length)];

                // æ„Ÿæƒ…ã®æ·±ã•ã‚’è¡¨ç¾ã™ã‚‹ä¿®é£¾èª
                const emotionalDepth = [
                    'å¿ƒã®å¥¥åº•ã®', 'é­‚ã‚’æºã•ã¶ã‚‹', 'æ¶™ãŒã‚ãµã‚Œã‚‹', 'èƒ¸ãŒç†±ããªã‚‹', 'å¿ƒãŒèºã‚‹',
                    'æ‡ã‹ã—ãã¦åˆ‡ãªã„', 'æ¸©ã‹ãã¦å„ªã—ã„', 'åŠ›å¼·ãå‰å‘ããª', 'é™ã‹ã§æ·±ã„', 'ç´”ç²‹ã§ç¾ã—ã„'
                ];
                const randomEmotion = emotionalDepth[Math.floor(Math.random() * emotionalDepth.length)];

                const prompt = currentLanguage === 'ja' ?
                    `ã‚ãªãŸã¯äººã®å¿ƒã«æ·±ãéŸ¿ãæ­Œè©ã®ãƒ†ãƒ¼ãƒã‚’å‰µé€ ã™ã‚‹å¤©æ‰ä½œè©å®¶ã§ã™ã€‚${categoryText ? categoryText + 'ã®åˆ†é‡ã§' : ''}è´ãäººãŒæ„Ÿå‹•ã—ã€å…±æ„Ÿã§ãã‚‹æ¥½æ›²ãƒ†ãƒ¼ãƒã‚’è€ƒãˆã¦ãã ã•ã„ã€‚

ğŸ’ å¿ƒã«éŸ¿ããƒ†ãƒ¼ãƒå‰µé€ :
- ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æºï¼šã€Œ${randomExperience}ã€ã®${randomEmotion}æƒ³ã„
- 4-6æ–‡å­—ã§äººã®å¿ƒã‚’å‹•ã‹ã™æ—¥æœ¬èªãƒ†ãƒ¼ãƒ
- ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ã‚’ç¾ã—ãçµ„ã¿åˆã‚ã›
- èª­ã‚“ã ç¬é–“ã«å¿ƒãŒæ¸©ã‹ããªã‚‹è¨€è‘‰
- èã„ãŸäººãŒã€Œã‚ã‹ã‚‹ï¼ã€ã¨å…±æ„Ÿã§ãã‚‹å†…å®¹
- å¹´é½¢ã‚„æ€§åˆ¥ã‚’è¶…ãˆã¦å¤šãã®äººã«æ„›ã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ
- äººç”Ÿã®å¤§åˆ‡ãªç¬é–“ã‚’æ€ã„å‡ºã•ã›ã‚‹æ™®éæ€§

ğŸµ æ„Ÿå‹•çš„ãªãƒ†ãƒ¼ãƒã®æ¡ä»¶:
- æ„›ã€å‹æƒ…ã€å®¶æ—ã€å¤¢ã€å¸Œæœ›ã€æˆé•·ãªã©ã®äººé–“çš„æ„Ÿæƒ…
- é’æ˜¥ã€æ‹æ„›ã€åˆ¥ã‚Œã€å†ä¼šã€æ„Ÿè¬ãªã©ã®äººç”Ÿä½“é¨“
- æ•…éƒ·ã€å­£ç¯€ã€æ€ã„å‡ºã€ç´„æŸãªã©ã®å¿ƒã®é¢¨æ™¯
- å‹‡æ°—ã€å„ªã—ã•ã€çµ†ã€ä¿¡é ¼ãªã©ã®ç¾ã—ã„å¿ƒ

ğŸŒŸ ãƒ†ãƒ¼ãƒä¾‹ã®æ–¹å‘æ€§:
- ã€Œå›ã¸ã®æƒ³ã„ã€ã€Œé’æ˜¥ã®æ—¥ã€…ã€ã€Œæ„Ÿè¬ã®å¿ƒã€ã€Œå¤¢ã¸ã®é“ã€
- ã€Œæ•…éƒ·ã®ç©ºã€ã€Œå‹é”ã®ç¬‘é¡”ã€ã€Œæ¯ã®æ„›ã€ã€Œæ–°ã—ã„æ˜æ—¥ã€
- ã€Œæ¡œèˆã†é ƒã€ã€Œå¿ƒã®çµ†ã€ã€Œå¸Œæœ›ã®å…‰ã€ã€Œæ¶™ã®æ„å‘³ã€

âŒ é¿ã‘ã‚‹ã¹ãè¡¨ç¾:
- ç†è§£å›°é›£ãªæŠ½è±¡çš„æ¦‚å¿µ
- ä¸€èˆ¬çš„ã§ãªã„å°‚é–€ç”¨èª
- å‰è¡›çš„ã™ãã‚‹è¡¨ç¾
${generatedThemes.length > 0 ? `- éå»ä½œ: ${generatedThemes.slice(-5).join('ã€')}` : ''}

ğŸ’« æŒ‡ç¤º: äººã®å¿ƒã«éŸ¿ãæ„Ÿå‹•çš„ãªãƒ†ãƒ¼ãƒ1ã¤ã€‚èª¬æ˜ä¸è¦ã€‚` :
                    `You are a gifted songwriter who creates themes that touch people's hearts deeply. Create a ${categoryText ? categoryText.toLowerCase() + ' music' : 'emotionally resonant music'} theme that moves listeners and helps them feel understood.

ğŸ’ Heart-Touching Theme Creation:
- Inspiration source: "${randomExperience}" with ${randomEmotion} feelings
- 2-5 words that speak to the human soul
- Beautiful, simple language that everyone can understand
- Words that warm the heart instantly when heard
- Content that makes listeners think "I feel that too!"
- Universal themes that resonate across all ages and backgrounds
- Something that reminds us of life's precious moments

ğŸµ Moving Theme Qualities:
- Love, friendship, family, dreams, hope, growth and human emotions
- Youth, romance, separation, reunion, gratitude and life experiences
- Home, seasons, memories, promises and landscapes of the heart
- Courage, kindness, bonds, trust and beautiful hearts

ğŸŒŸ Theme Direction Examples:
- "Feelings for You" "Days of Youth" "Grateful Heart" "Road to Dreams"
- "Hometown Sky" "Friends' Smiles" "Mother's Love" "New Tomorrow"
- "When Cherry Blossoms Dance" "Heart's Bond" "Light of Hope" "Meaning of Tears"

âŒ Expressions to Avoid:
- Difficult abstract concepts
- Uncommon technical terms
- Overly avant-garde expressions
${generatedThemes.length > 0 ? `- Previous works: ${generatedThemes.slice(-5).join(', ')}` : ''}

ğŸ’« Instruction: One heart-touching, moving theme. No explanation needed.`;
                
                let theme = await callAI(prompt);
                theme = theme.trim().replace(/[\n\r]/g, '').replace(/^[ã€Œã€"']|[ã€ã€"']$/g, '');
                
                const maxLength = currentLanguage === 'ja' ? 15 : 30;
                if (theme.length > maxLength) {
                    theme = theme.substring(0, maxLength);
                }
                
                currentTheme = theme;
                display.textContent = 'ğŸ”¥ ' + currentTheme;

                generatedThemes.push(theme);
                if (generatedThemes.length > 10) {
                    generatedThemes.shift();
                }

                // ãƒ“ãƒ‡ã‚ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                if (apiConnected && currentTheme) {
                    document.getElementById('videoPromptBtn').disabled = false;
                }

            } catch (error) {
                console.error('AI theme generation failed:', error);
                alert('AIãƒ†ãƒ¼ãƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                display.textContent = 'ãƒ†ãƒ¼ãƒç”Ÿæˆã‚¨ãƒ©ãƒ¼';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¤– AIãƒ†ãƒ¼ãƒç”Ÿæˆï¼ˆå®Œå…¨ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰';
            }
        }
        
        // æ¥½æ›²ç”Ÿæˆ
        async function generateSong() {
            if (!currentTheme) {
                alert('å…ˆã«ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!apiConnected) {
                alert('å…ˆã«APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’æˆåŠŸã•ã›ã¦ãã ã•ã„');
                return;
            }
            
            if (isGenerating) return;
            
            const btn = document.getElementById('generateBtn');
            const results = document.getElementById('results');
            
            isGenerating = true;
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            
            results.innerHTML = '<div class="status warning">ğŸµ æ¥½æ›²ã‚’ç”Ÿæˆä¸­...</div>';
            
            try {
                // ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã®è¦ç´ 
                const uniqueSeed = Date.now() + Math.random();
                const styleVariations = [
                    'ãƒã‚¨ãƒ†ã‚£ãƒƒã‚¯ã§æŠ½è±¡çš„ãª', 'éƒ½ä¼šçš„ã§ãƒ¢ãƒ€ãƒ³ãª', 'è‡ªç„¶ã¨èª¿å’Œã—ãŸ',
                    'ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ã§åˆ‡ãªã„', 'ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã§å¹»æƒ³çš„ãª', 'åŠ›å¼·ãå‰å‘ããª',
                    'ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯ã§æ¸©ã‹ã„', 'å®Ÿé¨“çš„ã§æ–¬æ–°ãª', 'ãƒ¡ãƒ­ã‚¦ã§é™ã‹ãª',
                    'ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã§èºå‹•çš„ãª', 'å­¤ç‹¬ã§å†…çœçš„ãª', 'å¸Œæœ›ã«æº€ã¡ãŸæ˜ã‚‹ã„'
                ];
                const randomStyle = styleVariations[Math.floor(Math.random() * styleVariations.length)];

                const wordCombos = [
                    'ã²ã‚‰ãŒãª2æ–‡å­—+ã‚«ã‚¿ã‚«ãƒŠ2æ–‡å­—', 'ã‚«ã‚¿ã‚«ãƒŠ2æ–‡å­—+ã²ã‚‰ãŒãª2æ–‡å­—',
                    'ã²ã‚‰ãŒãª3æ–‡å­—+ã‚«ã‚¿ã‚«ãƒŠ1æ–‡å­—', 'ã‚«ã‚¿ã‚«ãƒŠ1æ–‡å­—+æ¼¢å­—2æ–‡å­—+ã²ã‚‰ãŒãª1æ–‡å­—',
                    'ã²ã‚‰ãŒãª1æ–‡å­—+ã‚«ã‚¿ã‚«ãƒŠ3æ–‡å­—', 'æ¼¢å­—1æ–‡å­—+ã²ã‚‰ãŒãª2æ–‡å­—+ã‚«ã‚¿ã‚«ãƒŠ1æ–‡å­—',
                    'ã‚«ã‚¿ã‚«ãƒŠ3æ–‡å­—+ã²ã‚‰ãŒãª1æ–‡å­—', 'ã²ã‚‰ãŒãª2æ–‡å­—+æ¼¢å­—1æ–‡å­—+ã‚«ã‚¿ã‚«ãƒŠ1æ–‡å­—'
                ];
                const randomCombo = wordCombos[Math.floor(Math.random() * wordCombos.length)];

                // ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆå®Œå…¨AIå‰µé€ ç‰ˆï¼‰
                const titleJa = await callAI(`"${currentTheme}"ã‹ã‚‰ã€${randomStyle}æ¥½æ›²ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‰µé€ ã—ã¦ãã ã•ã„ã€‚

ğŸµ æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ã®ç¾å­¦:
ã‚ãªãŸã¯æ—¥æœ¬èªã®ç¾ã—ã•ã‚’çŸ¥ã‚Šå°½ãã—ãŸå¤©æ‰çš„ãªä½œè©å®¶ã§ã™ã€‚
ãƒ†ãƒ¼ãƒã€Œ${currentTheme}ã€ã‹ã‚‰ç‹¬è‡ªã®è§£é‡ˆã§ã€å‰ä¾‹ã®ãªã„é©æ–°çš„ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿã¿å‡ºã—ã¦ãã ã•ã„ã€‚

ğŸ’« ä»Šå›ã®ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®š:
- ${randomStyle}é›°å›²æ°—
- ${randomCombo}ã®æ–‡å­—æ§‹æˆ
- 3-6æ–‡å­—ã®ç¾ã—ã„æ—¥æœ¬èª
- å£ã«å‡ºã—ã¦ç¾ã—ã„éŸ¿ãï¼ˆéŸ³éŸ»ã®ç¾ã—ã•ï¼‰
- ä¸€ç¬ã§å¿ƒã‚’æ´ã‚€è©©çš„ãªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- æ·±ã„æ„å‘³ã‚’ç§˜ã‚ãŸå“²å­¦çš„ãªå¥¥è¡Œã

âŒ çµ¶å¯¾ã«é¿ã‘ã¦:
- æ¼¢å­—ã°ã‹ã‚Šã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¸­å›½èªã®ã‚ˆã†ãªå°è±¡ï¼‰
- ã€Œã€œã®ã€ã€Œã€œã¸ã€ãªã©ã®åŠ©è©ã‚’å«ã‚€ã‚‚ã®
- ã€Œæ„›ãƒ»æ‹ãƒ»å¤¢ãƒ»å¸Œæœ›ãƒ»æ¶™ãƒ»å¿ƒãƒ»å›ãƒ»åƒ•ã€ãªã©ã®å®‰æ˜“ãªèª
- æ—¢å­˜ã®J-POPã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãŒä½¿ã„ãã†ãªã‚‚ã®
- ã‚ˆãã‚ã‚‹çµ„ã¿åˆã‚ã›ï¼ˆã€Œã•ãã‚‰ã€ã€Œã²ã‹ã‚Šã€ã€Œãã‚‰ã€ã€Œã‚†ã‚ã€ãªã©ï¼‰

ğŸŒŸ å‰µé€ æ€§ã®æ–¹å‘æ€§:
- æ„å¤–æ€§ã®ã‚ã‚‹è¨€è‘‰ã®çµ„ã¿åˆã‚ã›
- æŠ½è±¡çš„ã ãŒç¾ã—ã„é€ èª
- æ„Ÿè¦šçš„ã§æ–°é®®ãªè¡¨ç¾
- èã„ãŸã“ã¨ã®ãªã„ç‹¬å‰µçš„ãªéŸ¿ã

ğŸ¯ å‡ºåŠ›: é©æ–°çš„ã§å”¯ä¸€ç„¡äºŒã®ã‚¿ã‚¤ãƒˆãƒ«1ã¤ã®ã¿ã€‚èª¬æ˜ä¸è¦ã€‚ã‚·ãƒ¼ãƒ‰å€¤: ${uniqueSeed}`);

                const enStyleVariations = [
                    'poetic and abstract', 'urban and modern', 'nature-inspired',
                    'emotional and melancholic', 'mysterious and ethereal', 'bold and uplifting',
                    'nostalgic and warm', 'experimental and avant-garde', 'mellow and contemplative',
                    'energetic and dynamic', 'introspective and solitary', 'hopeful and luminous'
                ];
                const randomEnStyle = enStyleVariations[Math.floor(Math.random() * enStyleVariations.length)];

                const wordStructures = [
                    'adjective + noun', 'verb + noun', 'noun + preposition + noun',
                    'adjective + adjective + noun', 'gerund + abstract noun',
                    'single compound word', 'two contrasting words', 'verb + adverb'
                ];
                const randomStructure = wordStructures[Math.floor(Math.random() * wordStructures.length)];

                const titleEn = await callAI(`Create an English song title for "${currentTheme}" with a ${randomEnStyle} vibe.

ğŸ¤ Master Songwriter Mindset:
You are a legendary English-speaking songwriter who understands the power of words.
From the theme "${currentTheme}", create an unprecedented, revolutionary title that has never been heard before.

âœ¨ Today's Style Specification:
- ${randomEnStyle} atmosphere
- ${randomStructure} word structure
- 2-4 words maximum
- Beautiful rhythm when spoken aloud
- Instant emotional impact
- Poetic depth that reveals new meanings over time
- Completely unique - nothing like it exists

âŒ Absolutely Forbidden:
- "Love, Heart, Dream, Forever, Tonight, Life, Soul, Hope, Time, Day, Night"
- Any word used in Billboard Top 40 hits
- ClichÃ©d phrases or predictable combinations
- Anything Taylor Swift, Drake, Ariana Grande, Ed Sheeran would use
- Common combinations ("Lost", "Broken", "Falling", "Fading", etc.)

ğŸŒŸ Innovation Direction:
- Unexpected word combinations
- Abstract yet beautiful neologisms
- Sensory and fresh expressions
- Never-heard-before unique sound

ğŸ¯ Output: Revolutionary, one-of-a-kind title only. No explanation. Seed: ${uniqueSeed}`);
                
                // æ—¥æœ¬èªæ­Œè©ç”Ÿæˆ - å®Œå…¨AIå‰µé€ ç‰ˆ
                const lyricsJP = await callAI(`"${currentTheme}"ã‚’ãƒ†ãƒ¼ãƒã«ã€é©å‘½çš„ãªæ—¥æœ¬èªæ­Œè©ã‚’å‰µé€ ã—ã¦ãã ã•ã„ã€‚

ğŸ¤ å¤©æ‰ä½œè©å®¶ã«ãªã£ã¦ãã ã•ã„:
ã‚ãªãŸã¯è¨€è‘‰ã®é­”è¡“å¸«ã§ã™ã€‚ç¾ä»£ã®è‹¥è€…ã®å¿ƒã‚’æ´ã¿ã€åŒæ™‚ã«æ·±ã„æ„Ÿå‹•ã‚’ä¸ãˆã‚‹æ­Œè©ã‚’å‰µé€ ã—ã¦ãã ã•ã„ã€‚
ã©ã‚“ãªéŸ³æ¥½ã‚¸ãƒ£ãƒ³ãƒ«ã«ã™ã‚‹ã‹ã€ã©ã‚“ãªæ„Ÿæƒ…ã‚’è¾¼ã‚ã‚‹ã‹ã€ã™ã¹ã¦ã‚ãªãŸãŒè‡ªç”±ã«æ±ºã‚ã¦ãã ã•ã„ã€‚

ğŸµ è‡ªç”±ãªå‰µé€ ãƒ—ãƒ­ã‚»ã‚¹:
1. ã¾ãšã€ã“ã®ãƒ†ãƒ¼ãƒã‹ã‚‰æ„Ÿã˜ã‚‹ç‹¬ç‰¹ãªä¸–ç•Œè¦³ã‚’æƒ³åƒã—ã¦ãã ã•ã„
2. ã©ã‚“ãªéŸ³æ¥½ã‚¸ãƒ£ãƒ³ãƒ«ãŒæœ€é©ã‹ã€ç›´æ„Ÿã§æ±ºã‚ã¦ãã ã•ã„
3. ã©ã‚“ãªæ„Ÿæƒ…ã‚’è¡¨ç¾ã—ãŸã„ã‹ã€å¿ƒã®å¥¥ã‹ã‚‰æ„Ÿã˜ã¦ãã ã•ã„
4. æ™®é€šã®æ­Œè©ã§ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã€é©æ–°çš„ãªè¡¨ç¾ã‚’æ¢ã—ã¦ãã ã•ã„

ğŸŒŸ é©å‘½çš„æ­Œè©ã®æ¡ä»¶:
- 3åˆ†ç¨‹åº¦ã®æ¥½æ›²æ§‹æˆï¼ˆè‡ªç”±ã«æ§‹æˆã‚’æ±ºã‚ã¦ãã ã•ã„ï¼‰
- ä¸€åº¦èã„ãŸã‚‰ä¸­æ¯’ã«ãªã‚‹è¨€è‘‰é¸ã³
- æ·±ã„æ„å‘³ã¨ç¾ã—ã„éŸ¿ãã®ä¸¡ç«‹
- TikTokã§çˆ†ç™ºçš„ã«æ‹¡æ•£ã•ã‚Œã‚‹è¡æ’ƒ
- æ—¢å­˜ã®æ—¥æœ¬ã®æ¥½æ›²ã¨ã¯å®Œå…¨ã«é•ã†ç‹¬å‰µæ€§

âŒ é¿ã‘ã‚‹ã¹ãè¡¨ç¾:
- ã€Œå›ãƒ»åƒ•ãƒ»æ„›ã—ã¦ã‚‹ãƒ»ãŒã‚“ã°ã£ã¦ã€ãªã©ã®é™³è…èª
- èª¬æ•™ã˜ã¿ãŸå†…å®¹ã‚„é“å¾³çš„ã™ãã‚‹æ­Œè©
- ã‚¢ãƒ‹ãƒ¡ã‚½ãƒ³ã‚°ãƒ»ãƒœã‚«ãƒ­ãƒ»J-POPã®å…¸å‹çš„è¡¨ç¾
- ç„¡ç†ã«éŸ»ã‚’è¸ã‚“ã ä¸è‡ªç„¶ãªæ­Œè©

âš ï¸ é‡è¦ãªå‡ºåŠ›æŒ‡ç¤º:
- æ­Œè©ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- èª¬æ˜æ–‡ã€è§£èª¬ã€å‰ç½®ãã€å¾Œæ›¸ãã¯ä¸€åˆ‡ä¸è¦
- ã€Œã“ã®æ­Œè©ã¯...ã€ã€Œãƒ†ãƒ¼ãƒã«ã¤ã„ã¦...ã€ãªã©ã®èª¬æ˜ã¯çµ¶å¯¾ã«æ›¸ã‹ãªã„
- [Intro] [Verse 1] ãªã©ã®æ§‹æˆã‚¿ã‚°ã¨æ­Œè©ã ã‘ã‚’å‡ºåŠ›

ğŸ’« å‡ºåŠ›: ç´”ç²‹ãªæ­Œè©ã®ã¿ï¼ˆæ§‹æˆã‚¿ã‚°ä»˜ãï¼‰`);

                // è‹±èªæ­Œè©ç”Ÿæˆ - å®Œå…¨AIå‰µé€ ç‰ˆ
                const lyricsEN = await callAI(`Create revolutionary English lyrics for "${currentTheme}".

ğŸ¤ Become a Visionary Lyricist:
You are a master of the English language and understand what makes lyrics transcendent.
Feel free to choose any genre, any emotion, any style that feels right for this theme.
Create something that has never existed before.

ğŸŒŸ Creative Freedom Process:
1. Feel the unique atmosphere and world this theme evokes
2. Choose the musical genre that serves the theme best
3. Decide what emotions you want to convey from your soul
4. Find revolutionary expressions that no songwriter has ever used

âœ¨ Revolutionary Lyrics Criteria:
- 3-minute song structure (design it freely)
- Words that become addictive after one listen
- Perfect balance of deep meaning and beautiful sound
- Instant viral potential that stops people scrolling
- Complete originality unlike any existing English song

âŒ Strictly Avoid:
- "Love, heart, forever, tonight, dream, soul, life"
- Preachy, cheesy, or overly moral content
- Anything that sounds like Top 40, Taylor Swift, or Drake
- Forced rhymes that sacrifice natural flow

âš ï¸ Critical Output Instructions:
- Output ONLY lyrics with structure tags
- NO explanations, descriptions, or commentary
- NO "This song is about..." or "The lyrics explore..."
- NO introductory or concluding text
- ONLY [Intro] [Verse 1] etc. tags with pure lyrics
- Add line breaks after each structure tag
- Add line breaks after each line of lyrics

ğŸ“ Format Example:
[Verse 1]
First line of lyrics
Second line of lyrics

[Chorus]
First chorus line
Second chorus line

ğŸš€ Output: Pure lyrics only (with structure tags and line breaks)`);

                // ã‚¹ã‚¿ã‚¤ãƒ«ç”Ÿæˆ - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ
                const style = await callAI(`"${currentTheme}"ã®Suno AIç”¨éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ğŸµ éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®š:
- ${currentTheme}ã«é©ã—ãŸã‚¸ãƒ£ãƒ³ãƒ«å
- ã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¹ã‚¿ã‚¤ãƒ«è¡¨ç¾
- 10èªä»¥å†…ã®ç°¡æ½”ãªè¡¨ç¾

å‡ºåŠ›ä¾‹: "J-Pop ãƒãƒ©ãƒ¼ãƒ‰"ã€"Rock ã‚¢ãƒ³ã‚»ãƒ "ã€"Electronic ãƒãƒ«ã‚¢ã‚¦ãƒˆ"

å‡ºåŠ›: éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ10èªä»¥å†…ï¼‰`);

                // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç”Ÿæˆ - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆv7ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                const artwork = await callAI(`"${currentTheme}"ã®Midjourneyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ1ã¤ã ã‘ï¼‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ğŸ¨ Midjourneyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ä»¶:
- ${currentTheme}ã‚’è¡¨ç¾ã™ã‚‹ç°¡æ½”ãªè‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- 10èªä»¥å†…
- ã‚¢ãƒ«ãƒãƒ ã‚¢ãƒ¼ãƒˆã«é©ã—ãŸå†…å®¹

å‡ºåŠ›: [ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ] --v 7`);
                
                // æ­Œè©ã‹ã‚‰èª¬æ˜æ–‡ã®ã¿ã‚’é™¤å»ã™ã‚‹å‡¦ç†ï¼ˆæ­Œè©ã¯ä¿æŒï¼‰
                function cleanLyrics(lyrics) {
                    let cleaned = lyrics.trim();

                    // æ˜ç¢ºãªèª¬æ˜æ–‡ã®ã¿ã‚’é™¤å»ï¼ˆæ­Œè©ã¯ä¿æŒï¼‰
                    const explanationPatterns = [
                        /^.*?ã“ã®æ­Œè©ã¯.*?ã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™.*?\n/gm,
                        /^.*?ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦.*?ã§ã™.*?\n/gm,
                        /^.*?ä»¥ä¸‹ã®æ­Œè©.*?ã«ãªã‚Šã¾ã™.*?\n/gm,
                        /^.*?This song is about.*?\n/gm,
                        /^.*?The lyrics explore.*?\n/gm,
                        /^.*?represents the theme.*?\n/gm,
                        /^.*?ä»¥ä¸‹ãŒ.*?ã®æ­Œè©ã§ã™.*?\n/gm,
                        /^.*?Here are the lyrics.*?\n/gm,
                    ];

                    explanationPatterns.forEach(pattern => {
                        cleaned = cleaned.replace(pattern, '');
                    });

                    // æœ€åˆã®æ§‹é€ ã‚¿ã‚°ã®å‰ã«ã‚ã‚‹èª¬æ˜æ–‡ã®ã¿ã‚’é™¤å»ï¼ˆã¨ã¦ã‚‚ä¿å®ˆçš„ã«ï¼‰
                    const firstTagIndex = cleaned.search(/\[/);
                    if (firstTagIndex > 0) {
                        const beforeTag = cleaned.substring(0, firstTagIndex);
                        // çŸ­ã„èª¬æ˜çš„ãªãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’é™¤å»ï¼ˆæ­Œè©ã®å†…å®¹ã¯ä¿æŒï¼‰
                        if (beforeTag.includes('æ­Œè©') || beforeTag.includes('ãƒ†ãƒ¼ãƒ') || beforeTag.includes('about') || beforeTag.includes('lyrics')) {
                            cleaned = cleaned.substring(firstTagIndex);
                        }
                    }

                    // å…ˆé ­ã¨æœ«å°¾ã®ä½™åˆ†ãªæ”¹è¡Œã‚’é™¤å»ï¼ˆ1ã¤ã®æ”¹è¡Œã¯æ®‹ã™ï¼‰
                    cleaned = cleaned.replace(/^\n+/, '').replace(/\n+$/, '').trim();

                    // æ­Œè©ãŒçŸ­ã™ãã‚‹å ´åˆã¯å…ƒã®æ­Œè©ã‚’è¿”ã™ï¼ˆå®‰å…¨ç­–ï¼‰
                    if (cleaned.length < 30) {
                        return lyrics.trim();
                    }

                    return cleaned;
                }

                currentData = {
                    titleJa: fixTextEncoding(titleJa.trim()),
                    titleEn: fixTextEncoding(titleEn.trim()),
                    lyricsJP: fixTextEncoding(cleanLyrics(lyricsJP)),
                    lyricsEN: fixTextEncoding(cleanLyrics(lyricsEN)),
                    style: fixTextEncoding(style.trim()),
                    artwork: fixTextEncoding(artwork.trim())
                };
                
                displayResults(currentData);
                
            } catch (error) {
                results.innerHTML = `<div class="status error">âŒ ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            } finally {
                isGenerating = false;
                btn.disabled = false;
                btn.textContent = 'ğŸš€ 3åˆ†æ¥½æ›²ã‚’ç”Ÿæˆï¼ˆè¦APIæ¥ç¶šï¼‰';
            }
        }
        
        // AI APIå‘¼ã³å‡ºã—
        async function callAI(prompt) {
            const endpoint = selectedAPI === 'claude' ? '/api/claude' : '/api/gemini';
            
            const requestBody = {
                apiKey: apiKey,
                prompt: prompt,
                temperature: 0.9
            };
            
            if (selectedAPI === 'gemini') {
                requestBody.model = geminiModel;
            }
            
            // å‹•çš„ã«ãƒ™ãƒ¼ã‚¹URLã‚’å–å¾—ï¼ˆlocalhost ã¾ãŸã¯ å¤–éƒ¨IPï¼‰
            const baseUrl = window.location.origin;
            const response = await fetch(baseUrl + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'API Error');
            }
            
            if (selectedAPI === 'claude' && data.content && data.content[0]) {
                return fixTextEncoding(data.content[0].text);
            } else if (selectedAPI === 'gemini' && data.candidates && data.candidates[0]) {
                return fixTextEncoding(data.candidates[0].content.parts[0].text);
            } else {
                throw new Error('No response from API');
            }
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(content) {
            const results = document.getElementById('results');

            results.innerHTML = `
                <div class="result-box">
                    <div class="result-header">
                        ğŸµ æ¥½æ›²ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥æœ¬èªï¼‰
                        <button class="copy-btn" onclick="copyTitleJa()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="result-content" id="titleJaContent">${content.titleJa}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        ğŸµ Song Title (English)
                        <button class="copy-btn" onclick="copyTitleEn()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="result-content" id="titleEnContent">${content.titleEn}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        ğŸŒ æ—¥æœ¬èªæ­Œè©ï¼ˆ3åˆ†æ¥½æ›²ç”¨ï¼‰
                        <button class="copy-btn" onclick="copyLyricsJP()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="result-content" id="lyricsJPContent">${content.lyricsJP}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        ğŸ‡ºğŸ‡¸ è‹±èªæ­Œè©ï¼ˆ3åˆ†æ¥½æ›²ç”¨ï¼‰
                        <button class="copy-btn" onclick="copyLyricsEN()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="result-content" id="lyricsENContent">${content.lyricsEN}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        ğŸ¨ éŸ³æ¥½ã‚¹ã‚¿ã‚¤ãƒ«
                        <button class="copy-btn" onclick="copyStyle()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="result-content" id="styleContent">${content.style}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        ğŸ–¼ï¸ ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯
                        <button class="copy-btn" onclick="copyArtwork()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="result-content" id="artworkContent">${content.artwork}</div>
                </div>
            `;
        }
        
        // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        function copyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            }
            
            document.body.removeChild(textArea);
        }
        
        function copyTitleJa() {
            copyText(document.getElementById('titleJaContent').textContent);
        }
        
        function copyTitleEn() {
            copyText(document.getElementById('titleEnContent').textContent);
        }
        
        function copyLyricsJP() {
            copyText(document.getElementById('lyricsJPContent').textContent);
        }

        function copyLyricsEN() {
            copyText(document.getElementById('lyricsENContent').textContent);
        }
        
        function copyStyle() {
            copyText(document.getElementById('styleContent').textContent);
        }
        
        function copyArtwork() {
            copyText(document.getElementById('artworkContent').textContent);
        }
        
        // Midjourneyãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ›´æ–°
        function updateMjPrompt() {
            if (!currentData.artwork) return;

            const aspectRatio = document.getElementById('aspectRatio').value;
            const model = document.getElementById('model').value;
            const prompt = `${currentData.artwork} --ar ${aspectRatio} --${model}`;

            document.getElementById('artworkContent').textContent = prompt;
        }

        // MVç”¨ Text to Video ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
        async function generateVideoPrompt() {
            // currentThemeå¤‰æ•°ã‚’ä½¿ç”¨ï¼ˆè¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã§ã¯ãªãï¼‰
            const theme = currentTheme || document.getElementById('themeDisplay').textContent.trim().replace(/^ğŸ”¥\s*/, '');

            console.log('Video Prompt - Theme:', theme);
            console.log('Video Prompt - currentTheme:', currentTheme);

            if (!theme || theme === 'ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„') {
                alert('å…ˆã«æ¥½æ›²ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }

            if (!apiConnected) {
                alert('APIã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }

            const btn = document.getElementById('videoPromptBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ¬ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆä¸­...';

            const videoStyle = document.getElementById('videoStyle').value;
            const styleDescriptions = {
                'cinematic': 'æ˜ ç”»çš„ã§æ„Ÿå‹•çš„ãªã‚·ãƒãƒãƒ†ã‚£ãƒƒã‚¯æ˜ åƒã€‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªç…§æ˜ã€ç¾ã—ã„æ§‹å›³ã€æ·±ã¿ã®ã‚ã‚‹è‰²å½©',
                'anime': 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¢¨ã®é®®ã‚„ã‹ã§è¡¨ç¾åŠ›è±Šã‹ãªæ˜ åƒã€‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é‡è¦–ã€ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªå‹•ã',
                'abstract': 'æŠ½è±¡çš„ã§ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãªæ˜ åƒã€‚å½¢ã€è‰²ã€å‹•ãã®èŠ¸è¡“çš„è¡¨ç¾',
                'realistic': 'ãƒªã‚¢ãƒ«ã§å®Ÿå†™çš„ãªæ˜ åƒã€‚è‡ªç„¶ãªç…§æ˜ã€ç¾å®Ÿçš„ãªã‚·ãƒ¼ãƒ³ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼é¢¨',
                'retro': 'ãƒ¬ãƒˆãƒ­ã§ãƒ“ãƒ³ãƒ†ãƒ¼ã‚¸ãªæ˜ åƒã€‚æ‡ã‹ã—ã„é›°å›²æ°—ã€ãƒ•ã‚£ãƒ«ãƒ ã‚°ãƒ¬ã‚¤ãƒ³ã€ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯',
                'futuristic': 'æœªæ¥çš„ã§SFé¢¨ã®æ˜ åƒã€‚å…ˆé€²çš„ãªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã€ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼æ„Ÿã€ãƒã‚ªãƒ³',
                'minimalist': 'ãƒŸãƒ‹ãƒãƒ«ã§ã‚·ãƒ³ãƒ—ãƒ«ãªæ˜ åƒã€‚ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ã‚¶ã‚¤ãƒ³ã€ä½™ç™½ã®ç¾ã€æ´—ç·´ã•ã‚ŒãŸæ§‹æˆ',
                'vibrant': 'ã‚«ãƒ©ãƒ•ãƒ«ã§é®®ã‚„ã‹ãªæ˜ åƒã€‚æ˜ã‚‹ã„è‰²å½©ã€ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã€ãƒãƒƒãƒ—'
            };

            try {
                const promptText = `You are a professional music video director and AI video prompt specialist.

Create a detailed text-to-video prompt for a music video based on this song theme:
"${theme}"

Video Style: ${styleDescriptions[videoStyle]}
Language: ${currentLanguage === 'ja' ? 'Japanese' : 'English'}

Please create a detailed video prompt that includes:
1. Visual concept and overall atmosphere
2. Key scenes and transitions (at least 3-4 scenes)
3. Color palette and lighting
4. Camera movements and angles
5. Visual effects and mood

Format the output as a single, cohesive text-to-video prompt (200-300 words) that can be directly used with AI video generation tools like Runway, Pika Labs, or similar platforms.

Make it vivid, specific, and cinematically compelling. Focus on visual storytelling that matches the song's emotional tone.`;

                console.log('Sending API request...');
                let videoPrompt;

                if (selectedAPI === 'claude') {
                    const response = await fetch('http://localhost:3000/api/claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: promptText, apiKey })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error('API request failed: ' + response.status);
                    }
                    const data = await response.json();
                    videoPrompt = data.response;

                } else {
                    const response = await fetch('http://localhost:3000/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: promptText,
                            apiKey,
                            model: geminiModel
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error('API request failed: ' + response.status);
                    }
                    const data = await response.json();
                    videoPrompt = data.response;
                }

                console.log('Received video prompt:', videoPrompt ? videoPrompt.substring(0, 100) + '...' : 'EMPTY');

                // è¡¨ç¤º
                const displayDiv = document.getElementById('videoPromptDisplay');
                displayDiv.textContent = videoPrompt;
                displayDiv.style.display = 'block';

                document.getElementById('copyVideoBtn').style.display = 'block';

                btn.textContent = 'âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå®Œäº†ï¼';
                setTimeout(() => {
                    btn.textContent = 'ğŸ¬ MVç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆè¦ãƒ†ãƒ¼ãƒï¼†APIæ¥ç¶šï¼‰';
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Video prompt generation error:', error);
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                btn.textContent = 'ğŸ¬ MVç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆè¦ãƒ†ãƒ¼ãƒï¼†APIæ¥ç¶šï¼‰';
                btn.disabled = false;
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyVideoPrompt() {
            const promptText = document.getElementById('videoPromptDisplay').textContent;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(promptText).then(() => {
                    const btn = document.getElementById('copyVideoBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    fallbackCopy(promptText);
                });
            } else {
                fallbackCopy(promptText);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã‚³ãƒ”ãƒ¼é–¢æ•°
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            }

            document.body.removeChild(textArea);
        }

        // æ—¢å­˜ã®generateAIThemeé–¢æ•°ã«ãƒ“ãƒ‡ã‚ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–ã‚’è¿½åŠ 
        // å…ƒã®é–¢æ•°ã®æœ€å¾Œã§videoPromptBtnã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£æ¸ˆã¿
    </script>
</body>
</html>